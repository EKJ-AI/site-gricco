generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ======================
 * Enums
 * ======================
 */
enum AuditAction {
  LOGIN
  LOGOUT
  CREATE
  UPDATE
  DELETE
  PERMISSION_CHANGE
  OTHER
}

enum BlogPostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

enum BlogPostType {
  NEWS
  ARTICLE
  PAGE
}

/**
 * ======================
 * Core (auth / rbac / audit)
 * ======================
 */
// Enable CITEXT in a migration SQL:
//   CREATE EXTENSION IF NOT EXISTS citext;
model User {
  id           Int        @id @default(autoincrement())
  name         String
  email        String     @unique
  passwordHash String
  profileId    String
  refreshToken String?    @unique
  profile      Profile    @relation(fields: [profileId], references: [id])
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  auditLogs    AuditLog[]

  // NOVO: posts de blog
  blogPostsAuthored BlogPost[] @relation("BlogPostsAuthor")
  blogPostsEdited   BlogPost[] @relation("BlogPostsLastEditor")

  isActive Boolean @default(true)

  @@index([createdAt])
}

model Profile {
  id          String              @id @default(uuid())
  name        String              @unique
  description String?
  users       User[]
  permissions ProfilePermission[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  deletedAt   DateTime?
}

model Permission {
  id          String              @id @default(uuid())
  name        String              @unique
  description String?
  profiles    ProfilePermission[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  deletedAt   DateTime?
}

model ProfilePermission {
  id           String     @id @default(uuid())
  profileId    String
  permissionId String
  profile      Profile    @relation(fields: [profileId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([profileId, permissionId])
  @@index([permissionId])
}

model AuditLog {
  id        Int         @id @default(autoincrement())
  action    AuditAction
  userId    Int?
  user      User?       @relation(fields: [userId], references: [id])
  details   String?
  ip        String?     @db.Inet
  userAgent String?
  createdAt DateTime    @default(now())

  @@index([userId, createdAt])
}

/**
 * ======================
 * i18n
 * ======================
 */
model Culture {
  id          String  @id @db.VarChar(10) // ex: 'pt-BR'
  description String
  icon        String
  order       Int
  active      Boolean @default(true)
  labels      Label[]

  @@index([active, order])
  @@index([description])
}

model Label {
  id          Int      @id @default(autoincrement())
  code        String
  key         String
  cultureId   String
  culture     Culture  @relation(fields: [cultureId], references: [id], onDelete: Cascade)
  description String
  tutorial    String?
  version     Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Hashes p/ evitar Ã­ndices enormes em (code/key)
  keyHash  String  @db.Char(32)
  codeHash String? @db.Char(32)

  // Uniques por hash (NULL em codeHash permite mÃºltiplos NULLs no Postgres)
  @@unique([cultureId, keyHash])
  @@unique([cultureId, codeHash])
  @@index([cultureId])
  @@index([code])
  @@index([key])
}

model BlogPost {
  id     String         @id @default(cuid())
  type   BlogPostType   @default(ARTICLE)
  status BlogPostStatus @default(DRAFT)

  title         String
  slug          String
  summary       String?
  content       String? // Markdown/HTML/texto
  coverImageUrl String?

  // SEO
  metaTitle       String?
  metaDescription String?

  // Destaques / mÃ©tricas simples
  isFeatured         Boolean @default(false)
  readingTimeMinutes Int?
  viewCount          Int     @default(0)

  // Escopo GLOBAL (sem company/establishment)
  // ðŸ”¥ Nada de companyId / establishmentId aqui

  // Auditoria
  authorId     Int
  lastEditorId Int?

  publishedAt DateTime?
  scheduledAt DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  author     User  @relation("BlogPostsAuthor", fields: [authorId], references: [id])
  lastEditor User? @relation("BlogPostsLastEditor", fields: [lastEditorId], references: [id])

  categories BlogPostCategory[]
  tags       BlogPostTag[]

  @@unique([slug])
  @@index([status, type, publishedAt])
}

model BlogCategory {
  id          String  @id @default(cuid())
  name        String
  slug        String
  description String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  posts BlogPostCategory[]

  @@unique([slug])
  @@index([name])
}

model BlogPostCategory {
  id         String @id @default(cuid())
  postId     String
  categoryId String

  post     BlogPost     @relation(fields: [postId], references: [id], onDelete: Cascade)
  category BlogCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([postId, categoryId])
  @@index([categoryId])
}

model BlogTag {
  id          String  @id @default(cuid())
  name        String
  slug        String
  description String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  posts BlogPostTag[]

  @@unique([slug])
  @@index([name])
}

model BlogPostTag {
  id     String @id @default(cuid())
  postId String
  tagId  String

  post BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag  BlogTag  @relation(fields: [tagId], references: [id])

  @@unique([postId, tagId])
  @@index([tagId])
}
