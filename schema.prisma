generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ======================
 * Enums
 * ======================
 */
enum AuditAction {
  LOGIN
  LOGOUT
  CREATE
  UPDATE
  DELETE
  PERMISSION_CHANGE
  OTHER
}

enum DocumentStatus {
  DRAFT
  ACTIVE
  INACTIVE
}

enum DocumentVersionStatus {
  PUBLISHED
  ARCHIVED
}

enum DocumentKind {
  MAIN // Documentos-mÃ£e (programas, laudos principais, planos)
  EVIDENCE // EvidÃªncias e registros (listas, exames, mediÃ§Ãµes, etc.)
}

enum DocumentRelationType {
  EVIDENCE // B Ã© evidÃªncia para A (ex: laudo â†’ PGR)
  SUPPORTING // B complementa A (anexo, apÃªndice, etc.)
  REPLACES // B substitui A (revisÃ£o normativa, nÃ£o tÃ©cnica de arquivo)
  DERIVED_FROM // B foi gerado a partir de A (relatÃ³rios derivados)
}

enum EstablishmentDocumentRole {
  MEMBER // sÃ³ aparece na lista, SEM acesso a documentos
  VIEWER // pode listar/ver/baixar documentos
  ASSISTANT // pode tudo de VIEWER + enviar documentos/versÃµes
}

enum DocumentAccessAction {
  VIEW
  DOWNLOAD
  UPLOAD
}

/**
 * ======================
 * Core (auth / rbac / audit)
 * ======================
 */
// Enable CITEXT in a migration SQL:
//   CREATE EXTENSION IF NOT EXISTS citext;
model User {
  id           Int        @id @default(autoincrement())
  name         String
  email        String     @unique
  passwordHash String
  profileId    String
  refreshToken String?    @unique
  profile      Profile    @relation(fields: [profileId], references: [id])
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  auditLogs    AuditLog[]

  // back-relations
  uploadedVersions DocumentVersion[]
  documentViews    DocumentView[]

  portalEmployees Employee[] // back-rel sem @relation name, Prisma infere

  // NOVO: empresas criadas por este usuÃ¡rio (Admin "local")
  companiesCreated Company[] @relation("UserCompaniesCreated")

  accessLogs DocumentAccessLog[] @relation("UserDocumentAccessLogs")

  isActive Boolean @default(true)

  @@index([createdAt])
}

model Profile {
  id          String              @id @default(uuid())
  name        String              @unique
  description String?
  users       User[]
  permissions ProfilePermission[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  deletedAt   DateTime?
}

model Permission {
  id          String              @id @default(uuid())
  name        String              @unique
  description String?
  profiles    ProfilePermission[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  deletedAt   DateTime?
}

model ProfilePermission {
  id           String     @id @default(uuid())
  profileId    String
  permissionId String
  profile      Profile    @relation(fields: [profileId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([profileId, permissionId])
  @@index([permissionId])
}

model AuditLog {
  id        Int         @id @default(autoincrement())
  action    AuditAction
  userId    Int?
  user      User?       @relation(fields: [userId], references: [id])
  details   String?
  ip        String?     @db.Inet
  userAgent String?
  createdAt DateTime    @default(now())

  @@index([userId, createdAt])
}

/**
 * ======================
 * i18n
 * ======================
 */
model Culture {
  id          String  @id @db.VarChar(10) // ex: 'pt-BR'
  description String
  icon        String
  order       Int
  active      Boolean @default(true)
  labels      Label[]

  @@index([active, order])
  @@index([description])
}

model Label {
  id          Int      @id @default(autoincrement())
  code        String
  key         String
  cultureId   String
  culture     Culture  @relation(fields: [cultureId], references: [id], onDelete: Cascade)
  description String
  tutorial    String?
  version     Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Hashes p/ evitar Ã­ndices enormes em (code/key)
  keyHash  String  @db.Char(32)
  codeHash String? @db.Char(32)

  // Uniques por hash (NULL em codeHash permite mÃºltiplos NULLs no Postgres)
  @@unique([cultureId, keyHash])
  @@unique([cultureId, codeHash])
  @@index([cultureId])
  @@index([code])
  @@index([key])
}

/**
 * ======================
 * Company / Establishment / Org Structure
 * ======================
 */
model Company {
  id          String    @id @default(cuid())
  tenantId    String?
  cnpj        String
  legalName   String
  tradeName   String?
  startAt     DateTime?
  companySize String?
  taxRegime   String?
  fiscalEmail String?
  phone       String?
  website     String?

  street       String?
  number       String?
  complement   String?
  district     String?
  city         String?
  state        String?
  zipCode      String?
  ibgeCityCode String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // NOVO: quem criou a empresa (Admin "dono")
  createdByUserId Int?
  createdBy       User? @relation("UserCompaniesCreated", fields: [createdByUserId], references: [id])

  isActive Boolean @default(true)

  establishments Establishment[]
  employees      Employee[]

  @@unique([cnpj]) // ðŸ‘ˆ agora CNPJ Ã© Ãºnico no sistema inteiro
  @@unique([tenantId, cnpj])
  @@index([createdByUserId])
}

model Establishment {
  id            String  @id @default(cuid())
  companyId     String
  cnpj          String
  nickname      String?
  mainCnae      String?
  riskLevel     Int?
  isHeadquarter Boolean @default(false)

  street       String?
  number       String?
  complement   String?
  district     String?
  city         String?
  state        String?
  zipCode      String?
  ibgeCityCode String?

  geoLat            Float?
  geoLng            Float?
  licenseNumber     String?
  licenseValidUntil DateTime?

  legalRepName String?
  legalRepCpf  String?

  isActive Boolean @default(true)

  company     Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  cnaes       EstablishmentCNAE[]
  departments Department[]
  documents   Document[]
  employees   Employee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, mainCnae])
}

model EstablishmentCNAE {
  id              String @id @default(cuid())
  establishmentId String
  cnaeId          String
  riskLevel       Int?

  establishment Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  cnae          CNAE          @relation(fields: [cnaeId], references: [id])

  @@unique([establishmentId, cnaeId])
}

model CNAE {
  id    String @id @default(cuid())
  code  String @unique
  title String

  nrRisk    Int?
  source    String?
  updatedAt DateTime?

  establishments EstablishmentCNAE[]
}

model Department {
  id              String  @id @default(cuid())
  establishmentId String
  name            String
  description     String?
  geoLat          Float?
  geoLng          Float?
  shift           String?
  workload        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  isActive Boolean @default(true)

  establishment Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  employees     Employee[]
}

model Employee {
  id              String    @id @default(cuid())
  companyId       String
  establishmentId String
  cpf             String
  name            String
  birthDate       DateTime?
  sex             String?
  registration    String?
  hiredAt         DateTime?
  dismissedAt     DateTime?
  bondType        String?
  jobTitle        String? // jÃ¡ existia, usado como cargo/funÃ§Ã£o
  cboId           String?     // ðŸ‘ˆ SEM @db.Uuid aqui
  departmentId    String?
  activityId      String?
  email           String?
  phone           String?

  // NOVO: vÃ­nculo opcional com o usuÃ¡rio que acessa o portal
  portalUserId       Int?
  portalUser         User?                     @relation(fields: [portalUserId], references: [id]) // ðŸ‘ˆ sugiro adicionar
  portalDocumentRole EstablishmentDocumentRole @default(MEMBER)

  nationality       String? // Nacionalidade (ex.: "Brasileira", "Portuguesa")
  preferredLanguage String? // Idioma (ex.: "pt-BR", "en-US", "es-ES")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  isActive Boolean @default(true)

  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  establishment Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  department    Department?   @relation(fields: [departmentId], references: [id])
  cbo           CBO?          @relation(fields: [cboId], references: [id])

  @@unique([companyId, cpf])
  @@index([establishmentId])
  @@index([portalUserId])
}

model CBO {
  id        String     @id @default(cuid())
  code      String     @unique
  title     String
  employees Employee[]
}

/**
 * ======================
 * Document Management
 * ======================
 */
model DocumentType {
  id          String       @id @default(cuid())
  name        String       @unique
  description String?
  kind        DocumentKind @default(MAIN) // MAIN ou EVIDENCE
  documents   Document[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // @@index([name])
  @@index([kind, name])
}

model Document {
  id              String         @id @default(cuid())
  establishmentId String
  typeId          String
  name            String
  description     String? // <--- NOVO
  status          DocumentStatus @default(ACTIVE)

  currentVersionId String?          @unique
  currentVersion   DocumentVersion? @relation("DocumentToCurrentVersion", fields: [currentVersionId], references: [id])

  versions DocumentVersion[] @relation("DocumentToVersions")

  mimetype String?
  hash     String?
  size     Int?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  establishment Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  type          DocumentType  @relation(fields: [typeId], references: [id])

  views DocumentView[]

  // RelaÃ§Ãµes com outros documentos (evidÃªncias, anexos, etc.)
  relatedAsParent DocumentRelation[] @relation("DocumentRelationsFrom")
  relatedAsChild  DocumentRelation[] @relation("DocumentRelationsTo")

  accessLogs DocumentAccessLog[] @relation("DocumentAccessLogs")

  @@index([establishmentId, typeId])
  @@index([name])
  @@index([status])
}

model DocumentRelation {
  id             String               @id @default(cuid())
  fromDocumentId String
  toDocumentId   String
  relationType   DocumentRelationType

  fromDocument Document @relation("DocumentRelationsFrom", fields: [fromDocumentId], references: [id], onDelete: Cascade)
  toDocument   Document @relation("DocumentRelationsTo", fields: [toDocumentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([fromDocumentId, toDocumentId, relationType])
  @@index([toDocumentId])
}

model DocumentVersion {
  id            String                @id @default(cuid())
  documentId    String
  versionNumber Int
  versionStatus DocumentVersionStatus @default(PUBLISHED)

  filename    String
  storagePath String // ex.: /uploads/<companyId>/<establishmentId>/<documentId>/<versionId>/<filename>
  storageKey  String?
  mimetype    String
  size        Int
  sha256      String

  uploadedByUserId Int?
  activatedAt      DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  currentOf Document? @relation("DocumentToCurrentVersion")

  document   Document @relation("DocumentToVersions", fields: [documentId], references: [id], onDelete: Cascade)
  uploadedBy User?    @relation(fields: [uploadedByUserId], references: [id])

  views DocumentView[]

  accessLogs DocumentAccessLog[] @relation("DocumentVersionAccessLogs")

  @@unique([documentId, versionNumber])
  @@index([documentId, versionNumber], map: "idx_doc_version_sequence")
  @@index([versionStatus])
}

model DocumentView {
  id                String   @id @default(cuid())
  documentId        String
  documentVersionId String
  userId            Int?
  viewedAt          DateTime @default(now())
  ip                String?  @db.Inet
  userAgent         String?

  document Document        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  version  DocumentVersion @relation(fields: [documentVersionId], references: [id], onDelete: Cascade)
  user     User?           @relation(fields: [userId], references: [id])

  @@index([documentId, documentVersionId, viewedAt])
  @@index([userId, viewedAt])
}

model DocumentAccessLog {
  id                String  @id @default(cuid())
  documentId        String
  documentVersionId String?
  userId            Int?

  action    DocumentAccessAction
  ip        String?
  userAgent String?
  createdAt DateTime             @default(now())

  // ðŸ‘‡ Lados das relaÃ§Ãµes (nomes batendo com os modelos acima)
  document Document         @relation("DocumentAccessLogs", fields: [documentId], references: [id])
  version  DocumentVersion? @relation("DocumentVersionAccessLogs", fields: [documentVersionId], references: [id])
  user     User?            @relation("UserDocumentAccessLogs", fields: [userId], references: [id])

  @@index([documentId, createdAt])
  @@index([documentVersionId])
  @@index([userId])
}
