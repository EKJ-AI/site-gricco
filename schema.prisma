generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ======================
 * Enums
 * ======================
 */
enum AuditAction {
  LOGIN
  LOGOUT
  CREATE
  UPDATE
  DELETE
  PERMISSION_CHANGE
  OTHER
}

enum DocumentStatus {
  DRAFT
  ACTIVE
  INACTIVE
}

enum DocumentVersionStatus {
  PUBLISHED
  ARCHIVED
}

enum DocumentKind {
  MAIN      // Documentos-mãe (programas, laudos principais, planos)
  EVIDENCE  // Evidências e registros (listas, exames, medições, etc.)
}

enum DocumentRelationType {
  EVIDENCE     // B é evidência para A (ex: laudo → PGR)
  SUPPORTING   // B complementa A (anexo, apêndice, etc.)
  REPLACES     // B substitui A (revisão normativa, não técnica de arquivo)
  DERIVED_FROM // B foi gerado a partir de A (relatórios derivados)
}

enum EstablishmentDocumentRole {
  MEMBER    // só aparece na lista, SEM acesso a documentos
  VIEWER    // pode listar/ver/baixar documentos
  ASSISTANT // pode tudo de VIEWER + enviar documentos/versões
}

/**
 * ======================
 * Core (auth / rbac / audit)
 * ======================
 */
// Enable CITEXT in a migration SQL:
//   CREATE EXTENSION IF NOT EXISTS citext;
model User {
  id           Int       @id @default(autoincrement())
  name         String
  email        String    @unique
  passwordHash String
  profileId    String
  refreshToken String?   @unique
  profile      Profile   @relation(fields: [profileId], references: [id])
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  auditLogs    AuditLog[]

  // back-relations
  uploadedVersions DocumentVersion[]
  documentViews    DocumentView[]

  // NOVO: empresas criadas por este usuário (Admin "local")
  companiesCreated Company[] @relation("UserCompaniesCreated")

  @@index([createdAt])
}

model Profile {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  users       User[]
  permissions ProfilePermission[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  profiles    ProfilePermission[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
}

model ProfilePermission {
  id           String     @id @default(uuid())
  profileId    String
  permissionId String
  profile      Profile    @relation(fields: [profileId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([profileId, permissionId])
  @@index([permissionId])
}

model AuditLog {
  id        Int         @id @default(autoincrement())
  action    AuditAction
  userId    Int?
  user      User?       @relation(fields: [userId], references: [id])
  details   String?
  ip        String?     @db.Inet
  userAgent String?
  createdAt DateTime    @default(now())

  @@index([userId, createdAt])
}

/**
 * ======================
 * i18n
 * ======================
 */
model Culture {
  id          String   @id @db.VarChar(10) // ex: 'pt-BR'
  description String
  icon        String
  order       Int
  active      Boolean  @default(true)
  labels      Label[]

  @@index([active, order])
  @@index([description])
}

model Label {
  id          Int      @id @default(autoincrement())
  code        String
  key         String
  cultureId   String
  culture     Culture  @relation(fields: [cultureId], references: [id], onDelete: Cascade)
  description String
  tutorial    String?
  version     Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Hashes p/ evitar índices enormes em (code/key)
  keyHash     String   @db.Char(32)
  codeHash    String?  @db.Char(32)

  @@index([cultureId])
  @@index([code])
  @@index([key])

  // Uniques por hash (NULL em codeHash permite múltiplos NULLs no Postgres)
  @@unique([cultureId, keyHash])
  @@unique([cultureId, codeHash])
}

/**
 * ======================
 * Company / Establishment / Org Structure
 * ======================
 */
model Company {
  id               String          @id @default(cuid())
  tenantId         String?
  cnpj             String
  legalName        String
  tradeName        String?
  startAt          DateTime?
  companySize      String?
  taxRegime        String?
  fiscalEmail      String?
  phone            String?
  website          String?

  street           String?
  number           String?
  complement       String?
  district         String?
  city             String?
  state            String?
  zipCode          String?
  ibgeCityCode     String?

  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // NOVO: quem criou a empresa (Admin "dono")
  createdByUserId  Int?
  createdBy        User?           @relation("UserCompaniesCreated", fields: [createdByUserId], references: [id])

  establishments   Establishment[]
  employees        Employee[]

  @@unique([tenantId, cnpj])
  @@index([createdByUserId])
}

model Establishment {
  id                     String             @id @default(cuid())
  companyId              String
  cnpj                   String
  nickname               String?
  mainCnae               String?
  riskLevel              Int?
  isHeadquarter          Boolean            @default(false)

  street                 String?
  number                 String?
  complement             String?
  district               String?
  city                   String?
  state                  String?
  zipCode                String?
  ibgeCityCode           String?

  geoLat                 Float?
  geoLng                 Float?
  licenseNumber          String?
  licenseValidUntil      DateTime?

  legalRepName           String?
  legalRepCpf            String?

  company                Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  cnaes                  EstablishmentCNAE[]
  departments            Department[]
  documents              Document[]
  employees              Employee[]

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([companyId, mainCnae])
}

model EstablishmentCNAE {
  id                String         @id @default(cuid())
  establishmentId   String
  cnaeId            String
  riskLevel         Int?

  establishment     Establishment  @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  cnae              CNAE           @relation(fields: [cnaeId], references: [id])

  @@unique([establishmentId, cnaeId])
}

model CNAE {
  id              String              @id @default(cuid())
  code            String              @unique
  title           String

  nrRisk          Int?
  source          String?
  updatedAt       DateTime?

  establishments  EstablishmentCNAE[]
}

model Department {
  id                String         @id @default(cuid())
  establishmentId   String
  name              String
  description       String?
  geoLat            Float?
  geoLng            Float?
  shift             String?
  workload          String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  establishment     Establishment  @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  employees         Employee[]
}

model Employee {
  id                String      @id @default(cuid())
  companyId         String
  establishmentId   String
  cpf               String
  name              String
  birthDate         DateTime?
  sex               String?
  registration      String?
  hiredAt           DateTime?
  dismissedAt       DateTime?
  bondType          String?
  cboId             String?
  jobTitle          String?
  departmentId      String?
  activityId        String?
  email             String?
  phone             String?

  // NOVO: vínculo opcional com o usuário que acessa o portal
  portalUserId      Int?
  portalDocumentRole EstablishmentDocumentRole @default(MEMBER)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company           Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  establishment     Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  department        Department?   @relation(fields: [departmentId], references: [id])
  cbo               CBO?          @relation(fields: [cboId], references: [id])

  @@unique([companyId, cpf])
  @@index([establishmentId])
  @@index([portalUserId])
}

model CBO {
  id            String     @id @default(cuid())
  code          String     @unique
  title         String
  employees     Employee[]
}

/**
 * ======================
 * Document Management
 * ======================
 */
model DocumentType {
  id          String       @id @default(cuid())
  name        String       @unique
  description String?
  kind        DocumentKind @default(MAIN)  // MAIN ou EVIDENCE
  documents   Document[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // @@index([name])
  @@index([kind, name])
}

model Document {
  id                String           @id @default(cuid())
  establishmentId   String
  typeId            String
  name              String
  description       String?          // <--- NOVO
  status            DocumentStatus   @default(ACTIVE)

  currentVersionId  String?          @unique
  currentVersion    DocumentVersion? @relation("DocumentToCurrentVersion", fields: [currentVersionId], references: [id])

  versions          DocumentVersion[] @relation("DocumentToVersions")

  mimetype          String?
  hash              String?
  size              Int?

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  deletedAt         DateTime?

  establishment     Establishment    @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  type              DocumentType     @relation(fields: [typeId], references: [id])

  views             DocumentView[]

  // Relações com outros documentos (evidências, anexos, etc.)
  relatedAsParent   DocumentRelation[] @relation("DocumentRelationsFrom")
  relatedAsChild    DocumentRelation[] @relation("DocumentRelationsTo")

  @@index([establishmentId, typeId])
  @@index([name])
  @@index([status])
}

model DocumentRelation {
  id             String               @id @default(cuid())
  fromDocumentId String
  toDocumentId   String
  relationType   DocumentRelationType

  fromDocument   Document             @relation("DocumentRelationsFrom", fields: [fromDocumentId], references: [id], onDelete: Cascade)
  toDocument     Document             @relation("DocumentRelationsTo", fields: [toDocumentId], references: [id], onDelete: Cascade)

  createdAt      DateTime             @default(now())

  @@unique([fromDocumentId, toDocumentId, relationType])
  @@index([toDocumentId])
}

model DocumentVersion {
  id                String                 @id @default(cuid())
  documentId        String
  versionNumber     Int
  versionStatus     DocumentVersionStatus  @default(PUBLISHED)

  filename          String
  storagePath       String                 // ex.: /uploads/<companyId>/<establishmentId>/<documentId>/<versionId>/<filename>
  storageKey        String?
  mimetype          String
  size              Int
  sha256            String

  uploadedByUserId  Int?
  activatedAt       DateTime?

  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  deletedAt         DateTime?

  currentOf         Document?              @relation("DocumentToCurrentVersion")

  document          Document               @relation("DocumentToVersions", fields: [documentId], references: [id], onDelete: Cascade)
  uploadedBy        User?                  @relation(fields: [uploadedByUserId], references: [id])

  views             DocumentView[]

  @@index([documentId, versionNumber], map: "idx_doc_version_sequence")
  @@index([versionStatus])
  @@unique([documentId, versionNumber])
}

model DocumentView {
  id                String          @id @default(cuid())
  documentId        String
  documentVersionId String
  userId            Int?
  viewedAt          DateTime        @default(now())
  ip                String?         @db.Inet
  userAgent         String?

  document          Document        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  version           DocumentVersion @relation(fields: [documentVersionId], references: [id], onDelete: Cascade)
  user              User?           @relation(fields: [userId], references: [id])

  @@index([documentId, documentVersionId, viewedAt])
  @@index([userId, viewedAt])
}
